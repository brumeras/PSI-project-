@page "/chat/{MatchedUsername}"
@using KNOTS.Models
@using System
@using KNOTS.Services.Chat
@using KNOTS.Services.Interfaces
@using Microsoft.JSInterop
@using System.Linq
@using System.Text.Json
@using KNOTS.Services
@inject IMessageService MessageService
@inject InterfaceUserService UserService
@inject IJSRuntime JSRuntime
@implements IDisposable
@rendermode InteractiveServer

<div class="chat-page">
    <div class="floating-pretzel pretzel-1">ü•®</div>
    <div class="floating-pretzel pretzel-2">ü•®</div>
    <div class="twinkle star-1">‚≠ê</div>
    <div class="twinkle star-2">‚≠ê</div>
    <div class="twinkle star-3">‚≠ê</div>

    <nav class="top-navigation">
        <div class="nav-content">
            <div class="nav-brand">
                <div class="brand-icon-wrapper">
                    <span class="brand-rope">ü•®</span>
                    <div class="brand-glow"></div>
                </div>
                <span class="brand-text">KNOTS</span>
            </div>
            <div class="nav-links">
                <a href="/Home" class="nav-link">
                    <span>Home</span>
                    <div class="link-shine"></div>
                </a>
                <a href="/activity" class="nav-link">
                    <span>My Activity</span>
                    <div class="link-shine"></div>
                </a>
                <a href="/leaderboard" class="nav-link">
                    <span>Top Knotters</span>
                    <div class="link-shine"></div>
                </a>
            </div>
            <a href="/" class="btn-logout">
                <span>Logout</span>
                <div class="btn-shimmer"></div>
            </a>
        </div>
    </nav>

    <div class="chat-container glass-card">
        <div class="chat-header">
            <div class="header-content">
                <div class="avatar-ring">@(string.IsNullOrWhiteSpace(MatchedUsername) ? "?" : MatchedUsername.Substring(0, 1).ToUpper())</div>
                <div>
                    <p class="eyebrow">Direct message</p>
                    <h3>Chat with @MatchedUsername</h3>
                </div>
            </div>
            <div class="header-actions">
                <a href="/Home" class="pill-link"><i class="bi bi-house-door"></i> Home</a>
                <a href="/activity" class="pill-link"><i class="bi bi-graph-up"></i> Activity</a>
            </div>
        </div>

        <div class="messages-container" @ref="messagesContainer">
            @if (isLoading)
            {
                <div class="loading-state">
                    <div class="spinner-border" style="color: #f888e9;" role="status"></div>
                    <p class="loading-text">Loading...</p>
                </div>
            }
            else if (messages.Any())
            {
                @foreach (var message in messages)
                {
                    <div class="message @(IsSentByCurrentUser(message) ? "sent" : "received")">
                        <div class="message-bubble">
                            <div class="message-content">@message.Content</div>
                            <div class="message-time">@message.SentAt.ToString("HH:mm")</div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="empty-chat">
                    <i class="bi bi-chat-dots"></i>
                    <p class="no-messages">Start the conversation with a friendly hello!</p>
                </div>
            }
        </div>

        <div class="input-container">
            <input @bind="messageInput"
                   @bind:event="oninput"
                   @onkeydown="HandleKeyPress"
                   placeholder="Type a message..."
                   class="message-input"
                   disabled="@isSending" />
            <button @onclick="SendMessage"
                    class="send-button"
                    disabled="@(string.IsNullOrWhiteSpace(messageInput) || isSending)">
                <i class="bi bi-send"></i> @(isSending ? "Sending..." : "Send")
            </button>
        </div>
    </div>
</div>

<style>
    .chat-page {
        min-height: 100vh;
        background: linear-gradient(135deg, #d8e7ff 0%, #cbd6ff 28%, #c6c1ff 58%, #dcd8ff 100%);
        width: 100%;
        position: relative;
        overflow: hidden;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        padding: 0 0 2.5rem;
        color: #1f2a3d;
    }

    :global(body) {
        margin: 0;
    }

    .floating-pretzel,
    .twinkle {
        position: absolute;
        z-index: 0;
        opacity: 0.9;
        filter: drop-shadow(0 12px 26px rgba(255, 193, 103, 0.2));
        user-select: none;
        pointer-events: none;
    }

    .floating-pretzel {
        font-size: 3.8rem;
        animation: pretzelDrift 12s ease-in-out infinite;
    }

    .pretzel-1 { top: 14%; right: 6%; animation-delay: -3s; }
    .pretzel-2 { bottom: 10%; left: 8%; animation-delay: -7s; }

    .twinkle {
        font-size: 2.4rem;
        animation: starBounce 9s ease-in-out infinite;
        color: #f7c948;
        text-shadow: 0 0 18px rgba(247, 201, 72, 0.55);
    }

    .star-1 { top: 22%; left: 12%; animation-duration: 9s; }
    .star-2 { bottom: 16%; right: 14%; animation-duration: 11s; }
    .star-3 { top: 40%; left: 48%; animation-duration: 13s; }

    @@keyframes pretzelDrift {
        0%, 100% { transform: translate(0, 0) rotate(-4deg); }
        25% { transform: translate(12px, -18px) rotate(4deg); }
        50% { transform: translate(-8px, 10px) rotate(-2deg); }
        75% { transform: translate(16px, 6px) rotate(6deg); }
    }

    @@keyframes starBounce {
        0%, 100% { transform: translateY(0) scale(1); opacity: 0.8; }
        30% { transform: translateY(-12px) scale(1.08); opacity: 1; }
        60% { transform: translateY(8px) scale(0.96); opacity: 0.9; }
    }

    .top-navigation {
        position: relative;
        z-index: 10;
        padding: 2rem 0 1rem;
        background: transparent;
        display: flex;
        justify-content: center;
    }

    .nav-content {
        width: min(1400px, calc(100% - 2.5rem));
        margin: 0 auto;
        padding: 1rem 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        background: rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(14px);
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.4);
        box-shadow: 0 16px 32px rgba(12, 19, 38, 0.16);
    }

    .nav-brand { display: flex; align-items: center; gap: 1rem; }

    .brand-icon-wrapper { position: relative; cursor: pointer; transition: transform 0.3s ease; }

    .brand-icon-wrapper:hover { transform: scale(1.1) rotate(6deg); }

    .brand-rope { font-size: 42px; display: inline-block; filter: drop-shadow(0 4px 20px rgba(248, 136, 233, 0.6)); animation: brandFloat 3s ease-in-out infinite; }

    @@keyframes brandFloat { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-5px) rotate(5deg); } }

    .brand-glow { position: absolute; top: 50%; left: 50%; width: 120%; height: 120%; transform: translate(-50%, -50%); background: radial-gradient(circle, rgba(248, 136, 233, 0.4) 0%, transparent 70%); animation: glowPulse 2s ease-in-out infinite; pointer-events: none; }

    @@keyframes glowPulse { 0%, 100% { opacity: 0.6; transform: translate(-50%, -50%) scale(1); } 50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); } }

    .brand-text { font-size: 1.8rem; font-weight: 800; background: linear-gradient(135deg, #f888e9 0%, #bd87f8 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; letter-spacing: 3px; }

    .nav-links { display: flex; gap: 1rem; }

    .nav-link { position: relative; padding: 0.75rem 1.5rem; border-radius: 15px; text-decoration: none; color: #333; font-weight: 700; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); overflow: hidden; }

    .nav-link span { position: relative; z-index: 1; }

    .nav-link::before { content: ''; position: absolute; inset: 0; background: rgba(255, 255, 255, 0.5); border-radius: 15px; opacity: 0; transition: opacity 0.3s ease; }

    .nav-link:hover::before { opacity: 1; }

    .nav-link:hover { transform: translateY(-2px); color: #f888e9; }

    .nav-link.active { background: linear-gradient(135deg, #f888e9 0%, #bd87f8 100%); color: white; box-shadow: 0 8px 25px rgba(248, 136, 233, 0.4); }

    .link-shine { position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent); transition: left 0.5s ease; }

    .nav-link:hover .link-shine { left: 100%; }

    .btn-logout { position: relative; padding: 0.75rem 1.5rem; border: none; border-radius: 15px; background: linear-gradient(135deg, #666 0%, #444 100%); color: white; font-weight: 700; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); overflow: hidden; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); text-decoration: none; }

    .btn-logout span { position: relative; z-index: 1; }

    .btn-logout .btn-shimmer { position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent); transition: left 0.5s ease; }

    .btn-logout:hover .btn-shimmer { left: 100%; }

    .btn-logout:hover { transform: translateY(-3px); box-shadow: 0 12px 35px rgba(0, 0, 0, 0.4); }

    .chat-container {
        width: min(1600px, calc(100% - 2rem));
        margin: 2rem auto 0;
        padding: 2.25rem 2rem;
        background: rgba(255, 255, 255, 0.94);
        border: 1px solid rgba(0, 0, 0, 0.05);
        border-radius: 24px;
        box-shadow: 0 18px 42px rgba(13, 27, 42, 0.12);
        position: relative;
        z-index: 1;
    }

    .chat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
        margin-bottom: 1.25rem;
    }

    .header-content { display: flex; align-items: center; gap: 1rem; }

    .avatar-ring {
        width: 64px;
        height: 64px;
        border-radius: 20px;
        background: linear-gradient(135deg, #f888e9 0%, #bd87f8 100%);
        color: #ffffff;
        display: grid;
        place-items: center;
        font-weight: 800;
        font-size: 1.5rem;
        box-shadow: 0 16px 32px rgba(189, 135, 248, 0.25);
    }

    .eyebrow {
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 2px;
        color: #9fb3ff;
        margin: 0 0 0.35rem 0;
        font-weight: 700;
    }

    .chat-header h3 { margin: 0; color: #1f2a3d; font-size: 1.8rem; font-weight: 800; }

    .header-actions { display: flex; align-items: center; gap: 0.75rem; }

    .pill-link {
        background: linear-gradient(135deg, rgba(248, 136, 233, 0.9) 0%, rgba(189, 135, 248, 0.9) 100%);
        color: #ffffff;
        text-decoration: none;
        font-weight: 800;
        padding: 0.75rem 1.3rem;
        border-radius: 18px;
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        border: 1px solid rgba(189, 135, 248, 0.6);
        box-shadow: 0 10px 22px rgba(189, 135, 248, 0.32);
        transition: all 0.3s ease;
    }
    .pill-link:hover { transform: translateY(-2px); box-shadow: 0 14px 30px rgba(189, 135, 248, 0.38); }
    .pill-link.subtle { background: linear-gradient(135deg, rgba(248, 136, 233, 0.12) 0%, rgba(189, 135, 248, 0.16) 100%); color: #8a3fc0; box-shadow: none; border-color: rgba(189, 135, 248, 0.35); }

    .messages-container {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(0, 0, 0, 0.05);
        border-radius: 18px;
        padding: 1.25rem;
        max-height: 60vh;
        overflow-y: auto;
        margin-bottom: 1.25rem;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.5);
    }

    .message { display: flex; margin-bottom: 0.9rem; }
    .message.sent { justify-content: flex-end; }

    .message-bubble {
        max-width: 70%;
        padding: 0.85rem 1rem;
        border-radius: 16px;
        background: rgba(248, 136, 233, 0.08);
        color: #1f2a3d;
        box-shadow: 0 8px 22px rgba(13, 27, 42, 0.12);
        position: relative;
        border: 1px solid rgba(248, 136, 233, 0.2);
    }

    .message.sent .message-bubble { background: linear-gradient(135deg, #f888e9 0%, #bd87f8 100%); color: #ffffff; border: none; box-shadow: 0 12px 28px rgba(189, 135, 248, 0.3); }

    .message-content { font-weight: 600; }
    .message-time { font-size: 0.85rem; color: #4f5672; margin-top: 0.35rem; }
    .message.sent .message-time { color: #0d1b2a; opacity: 0.7; }

    .loading-state { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; color: #1f2a3d; }
    .loading-text { margin: 0; font-weight: 700; }

    .empty-chat { text-align: center; color: #cdd4ff; padding: 2rem 1rem; }
    .empty-chat i { font-size: 3rem; color: #bd87f8; margin-bottom: 0.5rem; }
    .no-messages { margin: 0; font-weight: 700; }

    .input-container {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 0.75rem;
        align-items: center;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 16px;
        border: 1px solid rgba(0, 0, 0, 0.05);
        padding: 0.5rem 0.5rem 0.5rem 1rem;
    }

    .message-input {
        background: transparent;
        border: none;
        color: #1f2a3d;
        padding: 0.85rem 0.5rem;
        font-size: 1rem;
        outline: none;
    }

    .message-input::placeholder { color: #7a829e; }

    .send-button {
        background: linear-gradient(135deg, #f888e9 0%, #bd87f8 100%);
        color: #ffffff;
        border: none;
        border-radius: 12px;
        padding: 0.85rem 1.25rem;
        font-weight: 800;
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 12px 28px rgba(189, 135, 248, 0.32);
    }
    .send-button:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; }
    .send-button:not(:disabled):hover { transform: translateY(-2px); box-shadow: 0 16px 34px rgba(189, 135, 248, 0.4); }

    @@media (max-width: 992px) {
        .nav-links { display: none; }
        .chat-container { width: 100%; padding: 1.5rem; }
    }

    @@media (max-width: 768px) {
        .chat-header { flex-direction: column; align-items: flex-start; }
        .header-actions { width: 100%; }
        .pill-link { flex: 1; text-align: center; }
        .messages-container { max-height: 50vh; }
        .chat-container { padding: 1.25rem; }
    }

    @@media (max-width: 520px) {
        .chat-container { width: 100%; }
        .message-bubble { max-width: 100%; }
        .input-container { grid-template-columns: 1fr; }
        .send-button { width: 100%; justify-content: center; }
    }
</style>

@code {
    [Parameter] public string MatchedUsername { get; set; } = string.Empty;

    private List<Message> messages = new();
    private string messageInput = "";
    private string CurrentUsername = string.Empty;
    private ElementReference messagesContainer;
    private bool isLoading = true;
    private bool isSending = false;
    private bool isRefreshing = false;
    private DotNetObjectReference<ChatRazor>? dotNetRef;
    private Task? autoRefreshTask;
    private CancellationTokenSource? autoRefreshCts;
    private static int temporaryIdCounter = 0;
    private bool shouldScrollToBottom = false;
    private string? lastKnownMessageKey;
    private static readonly JsonSerializerOptions messageJsonOptions = new() { PropertyNameCaseInsensitive = true };
    
    protected override async Task OnInitializedAsync()
    {
        CurrentUsername = UserService.CurrentUser ?? string.Empty;

        if (!string.IsNullOrWhiteSpace(CurrentUsername) && !string.IsNullOrWhiteSpace(MatchedUsername))
        {
            await LoadMessages(forceScroll: true);
            StartAutoRefresh();
        }

        isLoading = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
        {
            await ScrollToBottomIfNeeded();
            return;
        }

        dotNetRef = DotNetObjectReference.Create(this);
        await JSRuntime.InvokeVoidAsync("setBlazorGameComponent", dotNetRef);

        if (!string.IsNullOrWhiteSpace(CurrentUsername))
        {
            await JSRuntime.InvokeAsync<bool>("ensureChatAndSetUsername", CurrentUsername);
        }

        await ScrollToBottomIfNeeded();
    }

    public void Dispose()
    {
        JSRuntime.InvokeVoidAsync("setBlazorGameComponent", (object?)null);
        dotNetRef?.Dispose();
        autoRefreshCts?.Cancel();
    }

    private async Task LoadMessages(bool forceScroll = false, bool detectNewMessages = false)
    {
        try
        {
            var previousKey = lastKnownMessageKey;
            var fetched = await MessageService.GetConversation(CurrentUsername, MatchedUsername);

            messages = fetched
                .OrderBy(m => m.SentAt)
                .ToList();

            lastKnownMessageKey = CreateMessageKey(messages.LastOrDefault());

            if (forceScroll || (detectNewMessages && lastKnownMessageKey != null && lastKnownMessageKey != previousKey))
            {
                shouldScrollToBottom = true;
            }

            await MessageService.MarkConversationAsRead(CurrentUsername, MatchedUsername);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading messages: {ex.Message}");
            messages = new List<Message>();
        }
    }
    
    private async Task RefreshMessages()
    {
        if (isRefreshing)
        {
            return;
        }

        isRefreshing = true;

        if (string.IsNullOrWhiteSpace(CurrentUsername) || string.IsNullOrWhiteSpace(MatchedUsername))
        {
            isRefreshing = false;
            return;
        }

        await LoadMessages(detectNewMessages: true);
        StateHasChanged();
        isRefreshing = false;
    }

    private void StartAutoRefresh()
    {
        if (autoRefreshTask != null && !autoRefreshTask.IsCompleted)
        {
            return;
        }

        autoRefreshCts?.Cancel();
        autoRefreshCts = new CancellationTokenSource();
        autoRefreshTask = RunAutoRefresh(autoRefreshCts.Token);
    }

    private async Task RunAutoRefresh(CancellationToken token)
    {
        using var timer = new PeriodicTimer(TimeSpan.FromSeconds(2));

        try
        {
            while (await timer.WaitForNextTickAsync(token))
            {
                await InvokeAsync(RefreshMessages);
            }
        }
        catch (OperationCanceledException)
        {
            // expected when disposing
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(messageInput) || isSending)
            return;

        if (string.IsNullOrWhiteSpace(CurrentUsername) || string.IsNullOrWhiteSpace(MatchedUsername))
        {
            Console.WriteLine("Cannot send message without valid participants");
            return;
        }

        isSending = true;

        try
        {
            var trimmed = messageInput.Trim();
            AddOptimisticMessage(trimmed);

            var connectionReady = await JSRuntime.InvokeAsync<bool>("ensureChatAndSetUsername", CurrentUsername);
            if (!connectionReady)
            {
                Console.WriteLine("Chat connection not ready; attempting direct send");
            }

            var sent = connectionReady && await JSRuntime.InvokeAsync<bool>("sendChatMessage", MatchedUsername, trimmed);

            if (!sent)
            {
                try
                {
                    var fallbackMessage = new Message
                    {
                        SenderId = CurrentUsername,
                        ReceiverId = MatchedUsername,
                        Content = trimmed,
                        SentAt = DateTime.UtcNow,
                        IsRead = false
                    };

                    await MessageService.SendMessage(fallbackMessage);
                    Console.WriteLine("Fallback direct send succeeded");
                }
                catch (Exception innerEx)
                {
                    Console.WriteLine($"Error during fallback send: {innerEx.Message}");
                }
            }

            if (!sent)
            {
                Console.WriteLine("Error sending message via chat hub");
            }

            messageInput = string.Empty;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error sending message: {ex.Message}");
        }
        finally
        {
            isSending = false;
            StateHasChanged();
        }
    }
    
    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await SendMessage();
        }
    }
    
    [JSInvokable("OnChatMessageReceived")]
    public async Task OnChatMessageReceived(string messageJson)
    {
        await HandleIncomingMessage(messageJson);
    }

    [JSInvokable("OnChatMessageSent")]
    public async Task OnChatMessageSent(string messageJson)
    {
        await HandleIncomingMessage(messageJson);
    }

    private async Task HandleIncomingMessage(string messageJson)
    {
        try
        {
            var message = System.Text.Json.JsonSerializer.Deserialize<Message>(messageJson, messageJsonOptions);
            if (message == null)
            {
                return;
            }

            var normalizedSender = Normalize(message.SenderId);
            var normalizedReceiver = Normalize(message.ReceiverId);
            var normalizedCurrent = Normalize(CurrentUsername);
            var normalizedMatch = Normalize(MatchedUsername);

            var isRelevant = (normalizedSender == normalizedCurrent && normalizedReceiver == normalizedMatch) ||
                             (normalizedSender == normalizedMatch && normalizedReceiver == normalizedCurrent);

            if (!isRelevant)
            {
                return;
            }

            RemoveMatchingPlaceholder(message);

            if (message.Id != 0 && messages.Any(m => m.Id == message.Id))
            {
                return;
            }

            messages.Add(message);
            messages = messages
                .OrderBy(m => m.SentAt)
                .ToList();
            lastKnownMessageKey = CreateMessageKey(messages.LastOrDefault());
            shouldScrollToBottom = true;

            if (normalizedReceiver == normalizedCurrent)
            {
                await MessageService.MarkConversationAsRead(CurrentUsername, MatchedUsername);
            }
            InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to handle incoming chat message: {ex.Message}");
        }
    }

    private static string Normalize(string value) => (value ?? string.Empty).Trim().ToLowerInvariant();

    private void AddOptimisticMessage(string content)
    {
        var placeholder = new Message
        {
            Id = Interlocked.Decrement(ref temporaryIdCounter),
            SenderId = CurrentUsername,
            ReceiverId = MatchedUsername,
            Content = content,
            SentAt = DateTime.Now,
            IsRead = false
        };

        messages.Add(placeholder);
        messages = messages
            .OrderBy(m => m.SentAt)
            .ToList();
        lastKnownMessageKey = CreateMessageKey(messages.LastOrDefault());
        shouldScrollToBottom = true;
        StateHasChanged();
    }

    private void RemoveMatchingPlaceholder(Message incoming)
    {
        var incomingContent = Normalize(incoming.Content);

        var placeholder = messages.FirstOrDefault(m =>
            m.Id < 0 &&
            Normalize(m.SenderId) == Normalize(CurrentUsername) &&
            Normalize(m.ReceiverId) == Normalize(MatchedUsername) &&
            Normalize(m.Content) == incomingContent);

        if (placeholder != null)
        {
            messages.Remove(placeholder);
        }
    }

    private bool IsSentByCurrentUser(Message message)
    {
        return Normalize(message.SenderId) == Normalize(CurrentUsername);
    }

    private static string? CreateMessageKey(Message? message)
    {
        if (message == null)
        {
            return null;
        }

        return $"{message.Id}-{message.SentAt:o}-{Normalize(message.SenderId)}-{Normalize(message.ReceiverId)}";
    }

    private async Task ScrollToBottomIfNeeded()
    {
        if (!shouldScrollToBottom)
        {
            return;
        }

        shouldScrollToBottom = false;

        try
        {
            await JSRuntime.InvokeVoidAsync("scrollMessagesToBottom", messagesContainer);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to scroll messages: {ex.Message}");
        }
    }
}